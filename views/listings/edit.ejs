<% layout('layouts/boilerplate') %>

<h1 class="mb-4">Edit Listing</h1>

<form action="/listings/<%= listing._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
  <div class="mb-3">
    <label class="form-label">Title</label>
    <input
      type="text"
      name="listing[title]"
      class="form-control"
      value="<%= listing.title %>"
      required
    >
  </div>

  <div class="mb-3">
    <label class="form-label">Description</label>
    <textarea
      name="listing[description]"
      class="form-control"
      rows="3"
      required
    ><%= listing.description %></textarea>
  </div>

  <div class="mb-3">
    <label class="form-label">Price (â‚¹)</label>
    <input
      type="number"
      name="listing[price]"
      class="form-control"
      min="0"
      step="any"
      value="<%= listing.price %>"
      required
    >
  </div>

  <div class="mb-3">
    <label class="form-label">Location</label>
    <input
      type="text"
      name="listing[location]"
      class="form-control"
      value="<%= listing.location %>"
      required
    >
  </div>

  <div class="mb-3">
    <label class="form-label">Country</label>
    <input
      type="text"
      name="listing[country]"
      class="form-control"
      value="<%= listing.country %>"
      required
    >
  </div>

  <div class="mb-3">
    <label class="form-label">Image (upload new to replace)</label>
    <input
      type="file"
      name="image"
      class="form-control mb-2"
    >
    <% if (listing.image && listing.image.url) { %>
      <small class="text-muted">
        Current image:
        <a href="<%= listing.image.url %>" target="_blank">view</a>
      </small>
    <% } %>
  </div>

  <div class="mb-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Select Location on Map</h6>
        <p class="text-muted small mb-2">Click on the map to set or update the exact location for your listing.</p>
        <div id="location-map" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #ddd;"></div>
        <div class="mt-2">
          <small class="text-muted">
            Selected: <span id="selected-coords">Click on the map to select location</span>
          </small>
        </div>
        <!-- Hidden fields to store coordinates -->
        <input type="hidden" name="listing[latitude]" id="latitude-input" value="<%= listing.latitude != null ? listing.latitude : '' %>" />
        <input type="hidden" name="listing[longitude]" id="longitude-input" value="<%= listing.longitude != null ? listing.longitude : '' %>" />
      </div>
    </div>
  </div>

  <button class="btn btn-success">Save Changes</button>
  <a href="/listings/<%= listing._id %>" class="btn btn-secondary ms-2">Cancel</a>
</form>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mapEl = document.getElementById("location-map");
    const latInput = document.getElementById("latitude-input");
    const lngInput = document.getElementById("longitude-input");
    const coordsDisplay = document.getElementById("selected-coords");

    // Get existing coordinates or default to India
    const existingLat = parseFloat(latInput.value) || 20.5937;
    const existingLng = parseFloat(lngInput.value) || 78.9629;
    const hasExistingCoords = latInput.value && lngInput.value && 
                              !isNaN(existingLat) && !isNaN(existingLng);

    // Initialize map
    const map = L.map(mapEl).setView([existingLat, existingLng], hasExistingCoords ? 13 : 5);

    // Add tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let marker = null;

    // If existing coordinates, show marker
    if (hasExistingCoords) {
      setMarker([existingLat, existingLng]);
    } else {
      // Try to get user's current location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userLat = pos.coords.latitude;
            const userLng = pos.coords.longitude;
            map.setView([userLat, userLng], 10);
            setMarker([userLat, userLng]);
          },
          (err) => {
            console.log("Could not get user location:", err);
          }
        );
      }
    }

    // Handle map click
    map.on("click", function (e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      setMarker([lat, lng]);
    });

    function setMarker(coords) {
      const [lat, lng] = coords;
      
      // Remove existing marker
      if (marker) {
        map.removeLayer(marker);
      }

      // Add new marker
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      
      // Update hidden inputs
      latInput.value = lat;
      lngInput.value = lng;
      
      // Update display
      coordsDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

      // Allow dragging marker
      marker.on("dragend", function (e) {
        const newLat = e.target.getLatLng().lat;
        const newLng = e.target.getLatLng().lng;
        latInput.value = newLat;
        lngInput.value = newLng;
        coordsDisplay.textContent = `${newLat.toFixed(6)}, ${newLng.toFixed(6)}`;
      });
    }
  });
</script>
